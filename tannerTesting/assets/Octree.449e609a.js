import{hc as k,ac as q,hk as Ot,hh as mt,iV as Rt,p as At,iS as M,n as p,by as Et,gb as $,a as J,iM as et,h5 as nt,iW as pt,ai as T}from"./index.3255d2a5.js";import{s as lt,d as it,a as Ft,f as Nt,r as bt,_ as C,p as ot,T as U,k as G,V as st,R as L}from"./sphere.67ec4acb.js";import{p as A,A as Mt,j as H,H as gt}from"./plane.a0a08b54.js";import{i as rt}from"./Util.3efb1a6b.js";function Z(i){return i?{ray:it(i.ray),c0:i.c0,c1:i.c1}:{ray:it(),c0:0,c1:Number.MAX_VALUE}}function vt(i,t=Z()){return Ft(i,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function wt(i,t){return ut(i,i.c0,t)}function kt(i,t){return ut(i,i.c1,t)}function ut(i,t,e){return k(e,i.ray.origin,q(e,i.ray.direction,t))}new lt(()=>Z());function qt(i){return i?[A(i[0]),A(i[1]),A(i[2]),A(i[3]),A(i[4]),A(i[5])]:[A(),A(),A(),A(),A(),A()]}function Bt(){return[p(),p(),p(),p(),p(),p(),p(),p()]}function Ct(i,t){for(let e=0;e<D.NUM;e++)Mt(i[e],t[e])}function Ut(i,t,e,n=Ht){const o=Ot(Nt.get(),t,i);mt(o,o);for(let s=0;s<Q.NUM;++s){const a=Rt(bt.get(),It[s],o);At(n[s],a[0]/a[3],a[1]/a[3],a[2]/a[3])}St(e,n)}function St(i,t){H(t[r.FAR_BOTTOM_LEFT],t[r.NEAR_BOTTOM_LEFT],t[r.NEAR_TOP_LEFT],i[g.LEFT]),H(t[r.NEAR_BOTTOM_RIGHT],t[r.FAR_BOTTOM_RIGHT],t[r.FAR_TOP_RIGHT],i[g.RIGHT]),H(t[r.FAR_BOTTOM_LEFT],t[r.FAR_BOTTOM_RIGHT],t[r.NEAR_BOTTOM_RIGHT],i[g.BOTTOM]),H(t[r.NEAR_TOP_LEFT],t[r.NEAR_TOP_RIGHT],t[r.FAR_TOP_RIGHT],i[g.TOP]),H(t[r.NEAR_BOTTOM_LEFT],t[r.NEAR_BOTTOM_RIGHT],t[r.NEAR_TOP_RIGHT],i[g.NEAR]),H(t[r.FAR_BOTTOM_RIGHT],t[r.FAR_BOTTOM_LEFT],t[r.FAR_TOP_LEFT],i[g.FAR])}function y(i,t){for(let e=0;e<D.NUM;e++){const n=i[e];if(n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]>=t[3])return!1}return!0}function Vt(i,t){for(let e=0;e<D.NUM;e++){const n=i[e];if(!gt(n,t))return!1}return!0}var g,r;(function(i){i[i.LEFT=0]="LEFT",i[i.RIGHT=1]="RIGHT",i[i.BOTTOM=2]="BOTTOM",i[i.TOP=3]="TOP",i[i.NEAR=4]="NEAR",i[i.FAR=5]="FAR"})(g||(g={})),function(i){i[i.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",i[i.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",i[i.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",i[i.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",i[i.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",i[i.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",i[i.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",i[i.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(r||(r={}));r.FAR_BOTTOM_RIGHT,r.NEAR_BOTTOM_RIGHT,r.NEAR_BOTTOM_LEFT,r.FAR_BOTTOM_LEFT,r.NEAR_BOTTOM_LEFT,r.NEAR_BOTTOM_RIGHT,r.NEAR_TOP_RIGHT,r.NEAR_TOP_LEFT,r.FAR_BOTTOM_RIGHT,r.FAR_BOTTOM_LEFT,r.FAR_TOP_LEFT,r.FAR_TOP_RIGHT,r.NEAR_BOTTOM_RIGHT,r.FAR_BOTTOM_RIGHT,r.FAR_TOP_RIGHT,r.NEAR_TOP_RIGHT,r.FAR_BOTTOM_LEFT,r.NEAR_BOTTOM_LEFT,r.NEAR_TOP_LEFT,r.FAR_TOP_LEFT,r.FAR_TOP_LEFT,r.NEAR_TOP_LEFT,r.NEAR_TOP_RIGHT,r.FAR_TOP_RIGHT;var D,Q;(function(i){i[i.NUM=6]="NUM"})(D||(D={})),function(i){i[i.NUM=8]="NUM"}(Q||(Q={}));const It=[M(-1,-1,-1,1),M(1,-1,-1,1),M(1,1,-1,1),M(-1,1,-1,1),M(-1,-1,1,1),M(1,-1,1,1),M(1,1,1,1),M(-1,1,1,1)];new lt(Z);const Ht=Bt();class x{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(t,e){this._objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new l,this._objectCount=0,e&&(e.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),e.maximumDepth!==void 0&&(this._maximumDepth=e.maximumDepth))}destroy(){this._degenerateObjects.clear(),l.clearPool(),Y[0]=null,S.prune(),I.prune()}add(t,e=t.length){this._objectCount+=e,this._grow(t,e);const n=l.acquire();for(let o=0;o<e;o++){const s=t[o];this._isDegenerate(s)?this._degenerateObjects.add(s):(n.init(this._root),this._add(s,n))}l.release(n)}remove(t,e=null){this._objectCount-=t.length;const n=l.acquire();for(const o of t){const s=J(e)?e:C(this._objectToBoundingSphere(o),Gt);z(s[3])?(n.init(this._root),this._remove(o,s,n)):this._degenerateObjects.delete(o)}l.release(n),this._shrink()}update(t,e){if(!z(e[3])&&this._isDegenerate(t))return;const n=Pt(t);this.remove(n,e),this.add(n)}forEachAlongRay(t,e,n){const o=ot(t,e);this._forEachNode(this._root,s=>{if(!this._intersectsNode(o,s))return!1;const a=s.node;return a.terminals.forAll(d=>{this._intersectsObject(o,d)&&n(d)}),a.residents!==null&&a.residents.forAll(d=>{this._intersectsObject(o,d)&&n(d)}),!0})}forEachAlongRayWithVerticalOffset(t,e,n,o){const s=ot(t,e);this._forEachNode(this._root,a=>{if(!this._intersectsNodeWithOffset(s,a,o))return!1;const d=a.node;return d.terminals.forAll(h=>{this._intersectsObjectWithOffset(s,h,o)&&n(h)}),d.residents!==null&&d.residents.forAll(h=>{this._intersectsObjectWithOffset(s,h,o)&&n(h)}),!0})}forEach(t){this._forEachNode(this._root,e=>{const n=e.node;return n.terminals.forAll(t),n.residents!==null&&n.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,e,n,o=()=>!0,s=1/0){let a=1/0,d=1/0,h=null;const c=V(t,e),f=u=>{if(--s,!o(u))return;const O=this._objectToBoundingSphere(u);if(!y(n,O))return;const F=B(t,e,G(O)),j=F-O[3],_=F+O[3];j<a&&(a=j,d=_,h=u)};return this._forEachNodeDepthOrdered(this._root,u=>{if(s<=0||!y(n,u.bounds)||(q(E,c,u.halfSize),k(E,E,u.bounds),B(t,e,E)>d))return!1;const O=u.node;return O.terminals.forAll(F=>f(F)),O.residents!==null&&O.residents.forAll(F=>f(F)),!0},t,e),h}forEachInDepthRange(t,e,n,o,s,a,d){let h=-1/0,c=1/0;const f={setRange:_=>{n===x.DepthOrder.FRONT_TO_BACK?(h=Math.max(h,_.near),c=Math.min(c,_.far)):(h=Math.max(h,-_.far),c=Math.min(c,-_.near))}};f.setRange(o);const u=B(e,n,t),O=V(e,n),F=V(e,-n),j=_=>{if(!d(_))return;const b=this._objectToBoundingSphere(_),P=G(b),tt=B(e,n,P)-u,ft=tt-b[3],Tt=tt+b[3];ft>c||Tt<h||!y(a,b)||s(_,f)};this._forEachNodeDepthOrdered(this._root,_=>{if(!y(a,_.bounds)||(q(E,O,_.halfSize),k(E,E,_.bounds),B(e,n,E)-u>c)||(q(E,F,_.halfSize),k(E,E,_.bounds),B(e,n,E)-u<h))return!1;const b=_.node;return b.terminals.forAll(P=>j(P)),b.residents!==null&&b.residents.forAll(P=>j(P)),!0},e,n)}forEachNode(t){this._forEachNode(this._root,e=>t(e.node,e.bounds,e.halfSize))}forEachNeighbor(t,e){const n=U(e),o=G(e),s=h=>{const c=this._objectToBoundingSphere(h),f=U(c),u=n+f;return!(et(G(c),o)-u*u<=0)||t(h)};let a=!0;const d=h=>{a&&(a=s(h))};this._forEachNode(this._root,h=>{const c=U(h.bounds),f=n+c;if(et(G(h.bounds),o)-f*f>0)return!1;const u=h.node;return u.terminals.forAll(d),a&&u.residents!==null&&u.residents.forAll(d),a}),a&&this.forEachDegenerateObject(d)}_intersectsNode(t,e){return v(e.bounds,2*-e.halfSize,m),v(e.bounds,2*e.halfSize,R),rt(t.origin,t.direction,m,R)}_intersectsNodeWithOffset(t,e,n){return v(e.bounds,2*-e.halfSize,m),v(e.bounds,2*e.halfSize,R),n.applyToMinMax(m,R),rt(t.origin,t.direction,m,R)}_intersectsObject(t,e){const n=this._objectToBoundingSphere(e);return!(n[3]>0)||st(n,t)}_intersectsObjectWithOffset(t,e,n){const o=this._objectToBoundingSphere(e);return!(o[3]>0)||st(n.applyToBoundingSphere(o),t)}_forEachNode(t,e){let n=l.acquire().init(t);const o=[n];for(;o.length!==0;){if(n=o.pop(),e(n)&&!n.isLeaf())for(let s=0;s<n.node.children.length;s++)n.node.children[s]&&o.push(l.acquire().init(n).advance(s));l.release(n)}}_forEachNodeDepthOrdered(t,e,n,o=x.DepthOrder.FRONT_TO_BACK){let s=l.acquire().init(t);const a=[s];for(jt(n,o,dt);a.length!==0;){if(s=a.pop(),e(s)&&!s.isLeaf())for(let d=7;d>=0;--d){const h=dt[d];s.node.children[h]&&a.push(l.acquire().init(s).advance(h))}l.release(s)}}_remove(t,e,n){S.clear();const o=n.advanceTo(e,(s,a)=>{S.push(s.node),S.push(a)})?n.node.terminals:n.node.residents;if(o.removeUnordered(t),o.length===0)for(let s=S.length-2;s>=0;s-=2){const a=S.data[s],d=S.data[s+1];if(!this._purge(a,d))break}}_nodeIsEmpty(t){if(t.terminals.length!==0)return!1;if(t.residents!==null)return t.residents.length===0;for(let e=0;e<t.children.length;e++)if(t.children[e])return!1;return!0}_purge(t,e){return e>=0&&(t.children[e]=null),!!this._nodeIsEmpty(t)&&(t.residents===null&&(t.residents=new $({shrink:!0})),!0)}_add(t,e){e.advanceTo(this._objectToBoundingSphere(t))?e.node.terminals.push(t):(e.node.residents.push(t),e.node.residents.length>this._maximumObjectsPerNode&&e.depth<this._maximumDepth&&this._split(e))}_split(t){const e=t.node.residents;t.node.residents=null;for(let n=0;n<e.length;n++){const o=l.acquire().init(t);this._add(e.getItemAt(n),o),l.release(o)}}_grow(t,e){if(e!==0&&(ht(t,e,n=>this._objectToBoundingSphere(n),N),z(N[3])&&!this._fitsInsideTree(N)))if(this._nodeIsEmpty(this._root.node))C(N,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const n=this._rootBoundsForRootAsSubNode(N);this._placingRootViolatesMaxDepth(n)?this._rebuildTree(N,n):this._growRootAsSubNode(n),l.release(n)}}_rebuildTree(t,e){nt(K,e.bounds),K[3]=e.halfSize,ht([t,K],2,o=>o,X);const n=l.acquire().init(this._root);this._root.initFrom(null,X,X[3]),this._root.increaseHalfSize(1.25),this._forEachNode(n,o=>(this.add(o.node.terminals.data,o.node.terminals.length),o.node.residents!==null&&this.add(o.node.residents.data,o.node.residents.length),!0)),l.release(n)}_placingRootViolatesMaxDepth(t){const e=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return this._forEachNode(this._root,o=>(n=Math.max(n,o.depth),n+e<=this._maximumDepth)),n+e>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const e=t[3],n=t;let o=-1/0;const s=this._root.bounds,a=this._root.halfSize;for(let h=0;h<3;h++){const c=s[h]-a-(n[h]-e),f=n[h]+e-(s[h]+a),u=Math.max(0,Math.ceil(c/(2*a))),O=Math.max(0,Math.ceil(f/(2*a)))+1,F=2**Math.ceil(Math.log(u+O)*Math.LOG2E);o=Math.max(o,F),w[h].min=u,w[h].max=O}for(let h=0;h<3;h++){let c=w[h].min,f=w[h].max;const u=(o-(c+f))/2;c+=Math.ceil(u),f+=Math.floor(u);const O=s[h]-a-c*a*2;W[h]=O+(f+c)*a}const d=o*a;return W[3]=d*_t,l.acquire().initFrom(null,W,d,0)}_growRootAsSubNode(t){const e=this._root.node;nt(N,this._root.bounds),N[3]=this._root.halfSize,this._root.init(t),t.advanceTo(N,null,!0),t.node.children=e.children,t.node.residents=e.residents,t.node.terminals=e.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const e=this._root.node.children;let n=0,o=0;for(;o<e.length&&t==null;)n=o++,t=e[n];for(;o<e.length;)if(e[o++])return-1;return n}_isDegenerate(t){return!z(this._objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const e=this._root.bounds,n=this._root.halfSize;return t[3]<=n&&t[0]>=e[0]-n&&t[0]<=e[0]+n&&t[1]>=e[1]-n&&t[1]<=e[1]+n&&t[2]>=e[2]-n&&t[2]<=e[2]+n}}class l{constructor(){this.bounds=L(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,e,n,o=this.depth){return this.node=J(t)?t:l.createEmptyNode(),J(e)&&C(e,this.bounds),this.halfSize=n,this.depth=o,this}increaseHalfSize(t){this.halfSize*=t,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*_t}advance(t){let e=this.node.children[t];e||(e=l.createEmptyNode(),this.node.children[t]=e),this.node=e,this.halfSize/=2,this.depth++;const n=ct[t];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(t,e,n=!1){for(;;){if(this.isTerminalFor(t))return e&&e(this,-1),!0;if(this.isLeaf()){if(!n)return e&&e(this,-1),!1;this.node.residents=null}const o=this._childIndex(t);e&&e(this,o),this.advance(o)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const e=this.bounds;return(e[0]<t[0]?1:0)+(e[1]<t[1]?2:0)+(e[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new $({shrink:!0}),residents:new $({shrink:!0})}}static acquire(){return l._pool.acquire()}static release(t){l._pool.release(t)}static clearPool(){l._pool.prune()}}function xt(i,t){i[0]=Math.min(i[0],t[0]-t[3]),i[1]=Math.min(i[1],t[1]-t[3]),i[2]=Math.min(i[2],t[2]-t[3])}function Lt(i,t){i[0]=Math.max(i[0],t[0]+t[3]),i[1]=Math.max(i[1],t[1]+t[3]),i[2]=Math.max(i[2],t[2]+t[3])}function v(i,t,e){e[0]=i[0]+t,e[1]=i[1]+t,e[2]=i[2]+t}function ht(i,t,e,n){if(t===1){const o=e(i[0]);C(o,n)}else{m[0]=1/0,m[1]=1/0,m[2]=1/0,R[0]=-1/0,R[1]=-1/0,R[2]=-1/0;for(let o=0;o<t;o++){const s=e(i[o]);z(s[3])&&(xt(m,s),Lt(R,s))}pt(n,m,R,.5),n[3]=Math.max(R[0]-m[0],R[1]-m[1],R[2]-m[2])/2}}function jt(i,t,e){if(!I.length)for(let n=0;n<8;++n)I.push({index:0,distance:0});for(let n=0;n<8;++n){const o=ct[n];I.data[n].index=n,I.data[n].distance=B(i,t,o)}I.sort((n,o)=>n.distance-o.distance);for(let n=0;n<8;++n)e[n]=I.data[n].index}function V(i,t){let e,n=1/0;for(let o=0;o<8;++o){const s=B(i,t,at[o]);s<n&&(n=s,e=at[o])}return e}function B(i,t,e){return t*(i[0]*e[0]+i[1]*e[1]+i[2]*e[2])}function z(i){return!isNaN(i)&&i!==-1/0&&i!==1/0&&i>0}l._pool=new Et(l),function(i){var t;(t=i.DepthOrder||(i.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(x||(x={}));const ct=[T(-1,-1,-1),T(1,-1,-1),T(-1,1,-1),T(1,1,-1),T(-1,-1,1),T(1,-1,1),T(-1,1,1),T(1,1,1)],at=[T(-1,-1,-1),T(-1,-1,1),T(-1,1,-1),T(-1,1,1),T(1,-1,-1),T(1,-1,1),T(1,1,-1),T(1,1,1)],_t=Math.sqrt(3),Y=[null];function Pt(i){return Y[0]=i,Y}const W=L(),E=p(),m=p(),R=p(),S=new $,Gt=L(),N=L(),K=L(),X=L(),w=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],I=new $,dt=[0,0,0,0,0,0,0,0],Wt=x;export{qt as H,g as U,Wt as V,Z as a,Vt as b,kt as g,wt as p,Ut as s,Ct as u,vt as y};
