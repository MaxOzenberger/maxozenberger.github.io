import{a as l,eb as Re,ae as K,jx as kt,jy as ze,jz as Ge,n as E,ac as X,h6 as se,ha as $,hb as le,h9 as $t,iB as Ht,iv as mt,e3 as De,e4 as Ae,jA as pe,b5 as Dt,hT as Ze,au as Fe,j7 as ke,gM as ce,jB as He,iW as H,t as g,jC as je,cM as Ue,jD as We,jE as Le,dS as Ne,a5 as s,a8 as he,jF as k,D as qe,s as Ye,a6 as h,a7 as z,a3 as Be,a0 as At,jG as yt,jH as vt,jk as Xe,J as at,H as F,c$ as Je,fK as Ke,j as st,b2 as ue,jI as wt,b3 as V,jJ as Zt,hs as Qe,eg as It,jK as dt,d$ as ft,jm as de,ai as Pt,L as jt,jL as ti,aa as ge,jM as me,jN as ye,I as Vt,E as ve,eB as Ct,cT as fe,e$ as ei,jO as ii,jP as ni,jQ as oi,ah as Ut,jR as _e,hc as ot,jS as Wt,jT as Lt,jU as Nt,Y as q,jV as qt,jW as ai,jX as ri,jp as si,ak as bt,jY as Yt,ab as Bt,iK as Tt}from"./index.3255d2a5.js";import{t as lt,j as R,U as J,a as Xt,m as li,b as St,c as pi,p as Jt,g as ct}from"./automaticLengthMeasurementUtils.06e82903.js";import{Q as ci,O as hi}from"./quat.eb7bbc3a.js";import{e as Kt}from"./quatf64.1dc83f1c.js";import{n as Mt,t as nt,c as M}from"./sphere.67ec4acb.js";import{i as Qt,a as Rt,w as ui,V as di,g as gi,p as mi,t as yi,b as vi,s as fi,c as _i}from"./SnappingContext.023005d4.js";import{k as xi,M as _t}from"./hydratedFeatures.b4cbc12d.js";import{i as xe}from"./GraphicManipulator.5182c2a7.js";import{W as we,J as wi}from"./boundedPlane.91a64206.js";function zt(t,e){return t===e||l(t)&&l(e)&&Re(t.spatialReference,e.spatialReference)&&t.x===e.x&&t.y===e.y&&t.z===e.z&&t.m===e.m}function gt(t,e,i=null){return l(i)?[t,e,i]:[t,e]}function v(t,e,i=null){return l(i)?{x:t,y:e,z:i}:{x:t,y:e}}class be{constructor(e){this.spatialReference=e}mapToLocalMultiple(e){return mt(e.map(i=>this.mapToLocal(i)))}get doUnnormalization(){return!1}}class bi extends be{constructor(e,i,n=null){super(i),this._defaultZ=n,this.transform=kt(),this.transformInv=kt(),this.transform=ze(e),Ge(this.transformInv,this.transform)}makeMapPoint(e,i){return gt(e,i,this._defaultZ)}mapToLocal(e){return v(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])}localToMap(e){return gt(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5],this._defaultZ)}}class Ti extends be{constructor(e,i){super(e.spatialReference),this.view=e,this.defaultZ=null,this.pWS=E(),this.tangentFrameUpWS=E(),this.tangentFrameRightWS=E(),this.tangentFrameForwardWS=E(),this.localFrameRightWS=E(),this.localFrameUpWS=E(),this.worldToLocalTransform=Kt(),this.localToWorldTransform=Kt(),this.scale=1,this.scale=e.resolution,this.referenceMapPoint=i,this.defaultZ=i.hasZ?i.z:null;const n=e.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,Mt.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,Mt.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,Mt.Z,this.tangentFrameForwardWS);const a=E();X(a,this.tangentFrameForwardWS,se(n,this.tangentFrameForwardWS)),$(this.localFrameRightWS,n,a),le(this.localFrameRightWS,this.localFrameRightWS),$t(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),ci(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),hi(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return this.view.viewingMode==="global"}makeMapPoint(e,i){return gt(e,i,this.defaultZ)}mapToLocal(e){const i=E();this.view.renderCoordsHelper.toRenderCoords(new K({x:e[0],y:e[1],spatialReference:this.spatialReference}),i),Ht(i,i,this.worldToLocalTransform);const n=this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference);return l(n)?v(n.x/this.scale,n.y/this.scale):null}localToMap(e){const i=E();this.view.renderCoordsHelper.toRenderCoords(new K({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),i),Ht(i,i,this.localToWorldTransform);const n=this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference);return l(n)?gt(n.x,n.y,this.defaultZ):null}}function te(t,e){if(t.type==="2d")return new bi(t.state.transform,t.spatialReference,e.length>2?e[2]:null);if(t.type==="3d"){const i=e.length>2?new K({x:e[0],y:e[1],z:e[2],spatialReference:t.spatialReference}):new K({x:e[0],y:e[1],spatialReference:t.spatialReference});return new Ti(t,i)}return null}function N(t,e){const i=new K({x:t[0],y:t[1],spatialReference:e});return t.length>2&&(i.z=t[2]),i}function Si(t,e){return new De({points:t,spatialReference:e})}function ee(t,e,i){const n=new Ae({paths:t,spatialReference:e});return i&&pe(n),n}function Q(t,e,i,n=!0){const a=Dt(t);a.forEach(r=>{const p=r[0],c=r[r.length-1];Ze(p,c)&&r.length!==1||r.push(r[0])});let o=new Fe({rings:a,spatialReference:e});return o.rings.forEach(r=>{ke(r,!1,!1)||r.reverse()}),i&&pe(o),n&&o.isSelfIntersecting&&ce(e)&&(o=He(o)),o}function ie(t,e,i){const n=e.mapToLocalMultiple(t),a=[],o={x:n[0].x,y:n[0].y},r={x:n[1].x,y:n[1].y},p=Math.round(r.x-o.x),c=Math.round(r.y-o.y),u=Math.max(Math.abs(p),Math.abs(c));if(i){const d={x:o.x+u,y:o.y+u},y={x:o.x-u,y:o.y-u};a.push(v(d.x,y.y),v(y.x,y.y),v(y.x,d.y),v(d.x,d.y))}else{const d={x:p>0?o.x+u:o.x-u,y:c>0?o.y+u:o.y-u};a.push(v(o.x,o.y),v(d.x,o.y),v(d.x,d.y),v(o.x,d.y))}return Te(Q([mt(a.map(d=>e.localToMap(d)))],e.spatialReference,e.doUnnormalization,!0),a,e)}function Mi(t,e,i){let n=e.mapToLocalMultiple(t);if(n.length===1){const c=n[0];n=[v(c.x-48,c.y+48),v(c.x+48,c.y-48),v(c.x+48,c.y-48),v(c.x-48,c.y+48)]}const a=[],o={x:n[0].x,y:n[0].y},r={x:n[1].x,y:n[1].y};if(i){const p=Math.round(r.x-o.x),c=Math.round(r.y-o.y);a.push(v(o.x-p,o.y-c),v(r.x,o.y-c),v(r.x,r.y),v(o.x-p,r.y))}else a.push(v(o.x,o.y),v(r.x,o.y),v(r.x,r.y),v(o.x,r.y));return Te(Q([mt(a.map(p=>e.localToMap(p)))],e.spatialReference,e.doUnnormalization,!0),a,e)}function Te(t,e,i){const n=ht(e[3],e[2],i),a=ht(e[1],e[2],i),o=ht(e[0],e[1],i),r=ht(e[0],e[3],i);return{geometry:t,midpoints:l(n)&&l(a)&&l(o)&&l(r)?{top:n,right:a,bottom:o,left:r}:null}}function ht(t,e,i){Y[0]=t.x,Y[1]=t.y,Y[2]=0,B[0]=e.x,B[1]=e.y,B[2]=0,H(Y,Y,B,.5),ut.x=Y[0],ut.y=B[1],ut.z=B[2];const n=i.localToMap(ut);return l(n)?N(n,i.spatialReference):null}const ut=v(0,0,0),Y=E(),B=E();function ne(t,e,i,n){const a=e.mapToLocalMultiple(t);let o=null,r=null;if(i)o=a[0],r=a[1];else{const x=a[0],w=a[1],I=Math.round(w.x-x.x),O=Math.round(w.y-x.y),S=Math.max(Math.abs(I),Math.abs(O));o=v(I>0?x.x+S/2:x.x-S/2,O>0?x.y+S/2:x.y-S/2),r=v(Math.abs(I)>Math.abs(O)?o.x-S/2:o.x,Math.abs(I)>Math.abs(O)?o.y:o.y-S/2)}const p=e.localToMap(o),c=e.localToMap(r);if(g(p)||g(c))return null;e.doUnnormalization&&je([[p,c]],e.spatialReference);const u=N(p,e.spatialReference),d=N(c,e.spatialReference),y=Ue(e.spatialReference);let f=0;if(ce(e.spatialReference))f=y*We(u,d,null);else{const x=o.x-r.x,w=o.y-r.y;f=y*Math.sqrt(x*x+w*w)*(n||1)}const b=new Le({center:u,radius:f,radiusUnit:"meters",spatialReference:e.spatialReference});return{geometry:Q(b.rings,b.spatialReference,!1),center:u,edge:d}}function Oi(t,e,i){const n=e.mapToLocalMultiple(t),a=n[0],o=n[1],r=Math.round(o.x-a.x),p=Math.round(o.y-a.y),c=v(i?a.x:a.x+r/2,i?a.y:a.y+p/2),u=i?r:r/2,d=i?p:p/2,y=60,f=[],b=2*Math.PI/y;function x(P){const it=Math.cos(P),pt=Math.sin(P);return v(u*it+c.x,d*pt+c.y)}for(let P=0;P<y;P++)f.push(x(P*b));f.push(f[0]);const{spatialReference:w,doUnnormalization:I}=e,O=Q([mt(f.map(P=>e.localToMap(P)))],w,I,!1),S=e.localToMap(x(Math.PI/2)),G=e.localToMap(x(0)),tt=e.localToMap(x(-Math.PI/2)),et=e.localToMap(x(Math.PI));return{geometry:O,midpoints:l(S)&&l(G)&&l(tt)&&l(et)?{top:N(S,w),right:N(G,w),bottom:N(tt,w),left:N(et,w)}:null}}var L;(function(t){t[t.WhenToolEditable=0]="WhenToolEditable",t[t.WhenToolNotEditable=1]="WhenToolNotEditable",t[t.Always=2]="Always"})(L||(L={}));class Ei{constructor(){this._isToolEditable=!0,this._manipulators=new Ne,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(e){this._isToolEditable=e}get length(){return this._manipulators.length}add(e,i=L.WhenToolEditable){this.addMany([e],i)}addMany(e,i=L.WhenToolEditable){for(const n of e){const a={manipulator:n,visibilityPredicate:i,attached:!1};this._manipulators.add(a),this._attached&&this._updateManipulatorAttachment(a)}}remove(e){for(let i=0;i<this._manipulators.length;i++)if(this._manipulators.getItemAt(i).manipulator===e){const n=this._manipulators.splice(i,1)[0];this._detachManipulator(n);break}}removeAll(){this._manipulators.forEach(e=>{this._detachManipulator(e)}),this._manipulators.removeAll()}attach(){this._manipulators.forEach(e=>{this._updateManipulatorAttachment(e)}),this._attached=!0}detach(){this._manipulators.forEach(e=>{this._detachManipulator(e)}),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach(({manipulator:e})=>{e.destroy&&e.destroy()}),this._manipulators.destroy(),this._resourceContexts=null}on(e,i){return this._manipulators.on(e,n=>{i(n)})}forEach(e){for(const i of this._manipulators.items)e(i)}some(e){return this._manipulators.items.some(e)}toArray(){const e=[];return this.forEach(i=>e.push(i.manipulator)),e}intersect(e,i){let n=null,a=Number.MAX_VALUE;return this._manipulators.forEach(({manipulator:o,attached:r})=>{if(!r||!o.interactive)return;const p=o.intersectionDistance(e,i);l(p)&&p<a&&(a=p,n=o)}),n}_updateManipulatorAttachment(e){this._isManipulatorItemVisible(e)?this._attachManipulator(e):this._detachManipulator(e)}_attachManipulator(e){e.attached||(e.manipulator.attach&&e.manipulator.attach(this._resourceContexts),e.attached=!0)}_detachManipulator(e){if(!e.attached)return;const i=e.manipulator;i.grabbing=!1,i.dragging=!1,i.hovering=!1,i.selected=!1,i.detach&&i.detach(this._resourceContexts),e.attached=!1}_isManipulatorItemVisible(e){return e.visibilityPredicate===L.Always||(this._isToolEditable?e.visibilityPredicate===L.WhenToolEditable:e.visibilityPredicate===L.WhenToolNotEditable)}}let T=class extends he{constructor(t){super(t),this.manipulators=new Ei,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[k.MANAGER,!0],[k.USER,!0]]),this._creationFinishedResolver=qe()}get active(){return this.view!=null&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(k.USER)}set editable(t){this.setEditableFlag(k.USER,t)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){g(this.view)?Ye.getLogger(this.declaredClass).error("Can't activate tool if view is not defined."):(this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,e){this._editableFlags.set(t,e),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===k.USER&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(t){var e;return(e=this._editableFlags.get(t))!=null?e:!1}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(k.USER)&&this.getEditableFlag(k.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized){if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};s([h({constructOnly:!0})],T.prototype,"view",void 0),s([h({readOnly:!0})],T.prototype,"active",null),s([h({value:!0})],T.prototype,"visible",null),s([h({value:!0})],T.prototype,"editable",null),s([h({readOnly:!0})],T.prototype,"manipulators",void 0),s([h({readOnly:!0})],T.prototype,"updating",null),s([h()],T.prototype,"cursor",null),s([h({readOnly:!0})],T.prototype,"automaticManipulatorSelection",void 0),s([h()],T.prototype,"hasFocusedManipulators",null),s([h()],T.prototype,"hasGrabbedManipulators",void 0),s([h()],T.prototype,"hasHoveredManipulators",void 0),s([h()],T.prototype,"firstGrabbedManipulator",void 0),s([h({readOnly:!0})],T.prototype,"created",void 0),s([h({readOnly:!0})],T.prototype,"removeIncompleteOnCancel",void 0),T=s([z("esri.views.interactive.InteractiveToolBase")],T);let j=class extends lt{constructor(t){super(t),this.type="draw-point",this.helpMessage=void 0}};s([h()],j.prototype,"type",void 0),s([h()],j.prototype,"elevation",void 0),s([h()],j.prototype,"viewType",void 0),s([h()],j.prototype,"helpMessage",void 0),j=s([z("esri.views.interactive.tooltip.DrawPointTooltipInfo")],j);let D=class extends lt{constructor(t){super(t),this.type="draw-polyline",this.totalLength=R,this.helpMessage=void 0}};s([h()],D.prototype,"type",void 0),s([h()],D.prototype,"elevation",void 0),s([h()],D.prototype,"totalLength",void 0),s([h()],D.prototype,"viewType",void 0),s([h()],D.prototype,"helpMessage",void 0),D=s([z("esri.views.interactive.tooltip.DrawPolylineTooltipInfo")],D);let A=class extends lt{constructor(t){super(t),this.type="draw-polygon",this.area=J,this.helpMessage=void 0}};s([h()],A.prototype,"type",void 0),s([h()],A.prototype,"elevation",void 0),s([h()],A.prototype,"area",void 0),s([h()],A.prototype,"viewType",void 0),s([h()],A.prototype,"helpMessage",void 0),A=s([z("esri.views.interactive.tooltip.DrawPolygonTooltipInfo")],A);let U=class extends lt{constructor(t){super(t),this.type="draw-rectangle",this.xSize=R,this.ySize=R,this.area=J}};s([h()],U.prototype,"type",void 0),s([h()],U.prototype,"xSize",void 0),s([h()],U.prototype,"ySize",void 0),s([h()],U.prototype,"area",void 0),U=s([z("esri.views.interactive.tooltip.DrawRectangleTooltipInfo")],U);let Z=class extends lt{constructor(t){super(t),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=J}};s([h()],Z.prototype,"type",void 0),s([h()],Z.prototype,"radius",void 0),s([h()],Z.prototype,"xSize",void 0),s([h()],Z.prototype,"ySize",void 0),s([h()],Z.prototype,"area",void 0),Z=s([z("esri.views.interactive.tooltip.DrawCircleTooltipInfo")],Z);let m=class extends Be(At.EventedMixin(T)){constructor(t){super(t),this._graphic=null,this._createOperationGeometry=null,this.defaultZ=0,this.geometryType=null,this.hasZ=!0,this.labelOptions=new yt,this.mode=null,this.snappingManager=null,this.snapToScene=!1,this.tooltip=null,this.tooltipOptions=new vt}initialize(){this.internalGraphicsLayer=new Xe({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer),this.drawOperation=this.makeDrawOperation(),this.handles.add([this.drawOperation.on("vertex-add",t=>this.onVertexAdd(t)),this.drawOperation.on("vertex-remove",t=>this.onVertexRemove(t)),this.drawOperation.on("vertex-update",t=>this.onVertexUpdate(t)),this.drawOperation.on("cursor-update",t=>this.onCursorUpdate(t)),this.drawOperation.on("complete",t=>this.onComplete(t)),at(()=>this.tooltipOptions.enabled,t=>{this.tooltip=t?new pi({view:this.view,info:this._tooltipInfo}):F(this.tooltip)},It),at(()=>this._tooltipInfo,t=>{l(this.tooltip)&&(this.tooltip.info=t)},It)]),this.finishToolCreation()}destroy(){this.drawOperation=F(this.drawOperation),this.tooltip=F(this.tooltip),this._destroyAllVisualisations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=F(this.internalGraphicsLayer),this._set("view",null)}get _defaultElevation(){return Xt(this.defaultZ,"meters")}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),l(this._graphic)&&(this._graphic.symbol=t)}get updating(){var t,e;return(e=(t=this.drawOperation)==null?void 0:t.updating)!=null?e:!1}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}_createGraphic(t){this._graphic=new Je({...this.graphicProperties,geometry:t,symbol:this.graphicSymbol}),this.internalGraphicsLayer.add(this._graphic),this.handles.add(this.initializeGraphic(this._graphic)),this.notifyChange("graphic"),this.handles.add(Ke(()=>{l(this._graphic)&&(this.internalGraphicsLayer.remove(this._graphic),this._graphic=F(this._graphic))}),Ot)}_destroyAllVisualisations(){this.handles.remove(C.outline),this.handles.remove(C.regularVertices),this.handles.remove(C.activeVertex),this.handles.remove(Ot)}_getCreateOperationGeometry(t={operationComplete:!1}){if(this.drawOperation==null||this.drawOperation.numVertices===0)return null;const e=this.drawOperation.stagedVertex,i=this.drawOperation.committedVertices,n=i.slice();l(e)&&n.push(this.drawOperation.coordinateHelper.pointToArray(e));const a=l(e)?this.drawOperation.coordinateHelper.pointToArray(e):i.splice(-1)[0],o={regularVertices:null,activeVertex:null,full:null,outline:null,circle:null,rectangle:null},r=n.length,p=this.view.spatialReference,c=this.view.type==="3d"&&this.view.viewingMode==="global";switch(this.geometryType){case"point":o.regularVertices=i,o.activeVertex=a,o.full=this.drawOperation.coordinateHelper.arrayToPoint(n[0]);break;case"multipoint":o.regularVertices=i,o.activeVertex=a,r>0&&(o.full=Si(n,p));break;case"polyline":o.regularVertices=i,o.activeVertex=a,r>0&&(o.full=ee([n],p,c));break;case"polygon":o.regularVertices=i,o.activeVertex=a,r>0&&(o.full=Q([n],p,c,!0));break;case"circle":if(r>0){const u=te(this.view,n[0]);if(r===1&&t.operationComplete){const d=n[0],y=u.makeMapPoint(d[0]+oe*this.view.resolution,d[1]);o.circle=ne([d,y],u,!0),o.full=l(o.circle)?o.circle.geometry:null}else r===2&&(this.forceUniformSize?(o.circle=ne(n,u,this.centered),o.full=l(o.circle)?o.circle.geometry:null):(o.rectangle=Oi(n,u,this.centered),o.full=o.rectangle.geometry))}break;case"rectangle":if(r>0){const u=te(this.view,n[0]);if(r===1&&t.operationComplete){const d=n[0],y=u.makeMapPoint(d[0]+oe*this.view.resolution,d[1]);o.rectangle=ie([d,y],u,!0),o.full=o.rectangle.geometry}else r===2&&(o.rectangle=this.forceUniformSize?ie(n,u,this.centered):Mi(n,u,this.centered),o.full=o.rectangle.geometry)}break;default:return null}switch(this.geometryType){case"point":case"multipoint":break;case"polyline":case"polygon":r>1&&(o.outline=ee([n],p,c));break;case"circle":case"rectangle":l(o.full)&&o.full.type==="polygon"&&(o.outline=Q(o.full.rings,p,c))}return o}initializeGraphic(t){return null}onComplete(t){this._updateGraphic();let e=null;if(this.drawOperation.isCompleted){const i=this._getCreateOperationGeometry({operationComplete:!0});l(i)&&(g(this._graphic)?this._createGraphic(i.full):this._graphic.geometry=i.full,e=st(this._graphic).clone())}this._createOperationGeometry=null,this.emit("complete",{graphic:e,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}onVertexAdd(t){this._updateGraphic(),this.emit("vertex-add",t)}onVertexRemove(t){this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,g(t)?this._destroyAllVisualisations():(l(t.outline)?this.handles.add(this.onOutlineChanged(t.outline),C.outline):this.handles.remove(C.outline),l(t.regularVertices)?this.handles.add(this.onRegularVerticesChanged(t.regularVertices),C.regularVertices):this.handles.remove(C.regularVertices),l(t.activeVertex)?this.handles.add(this.onActiveVertexChanged(t.activeVertex),C.activeVertex):this.handles.remove(C.activeVertex),l(t.full)?g(this._graphic)?this._createGraphic(t.full):this._graphic.geometry=t.full:this.handles.remove(Ot))}get _tooltipInfo(){const{drawOperation:t}=this;if(!t)return null;switch(this.geometryType){case"point":return this._drawPointTooltipInfo;case"polyline":return this._drawPolylineTooltipInfo;case"polygon":return this._drawPolygonTooltipInfo;case"rectangle":return this._drawRectangleTooltipInfo;case"circle":return this._drawCircleTooltipInfo;default:return null}}get _drawPointTooltipInfo(){const t=ue(this.graphic,e=>e.geometry);return g(t)||t.type!=="point"||this.view.type==="2d"&&this.defaultZ===0?null:new j({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,viewType:this.view.type,helpMessage:wt("point",t)})}get _drawPolylineTooltipInfo(){const t=this._createOperationGeometry,e=l(t)?t.full:null;if(g(e)||e.type!=="polyline")return null;const i=li(e,this._elevationMode);return new D({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,totalLength:V(i,R),viewType:this.view.type,helpMessage:wt("polyline",e)})}get _drawPolygonTooltipInfo(){const t=this._createOperationGeometry,e=l(t)?t.full:null;if(g(e)||e.type!=="polygon")return null;const i=Qt(e,this._elevationMode);return new A({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,area:V(i,J),viewType:this.view.type,helpMessage:wt("polygon",e)})}get _drawRectangleTooltipInfo(){return g(this.drawOperation)?null:new U({tooltipOptions:this.tooltipOptions,xSize:V(this._xSize,R),ySize:V(this._ySize,R),area:V(this._fullGeometryArea,J)})}get _drawCircleTooltipInfo(){if(g(this.drawOperation))return null;const t=this.forceUniformSize;return new Z({tooltipOptions:this.tooltipOptions,radius:t?V(this._circleRadius,R):null,xSize:t?null:V(this._xSize,R),ySize:t?null:V(this._ySize,R),area:V(this._fullGeometryArea,J)})}get _circleRadius(){const t=this._createOperationGeometry;return l(t)&&l(t.circle)&&l(t.circle.center)&&l(t.circle.edge)?St(t.circle.center,t.circle.edge,this._elevationMode):null}get _xSize(){const t=this._createOperationGeometry;if(g(t)||g(t.rectangle))return null;const{midpoints:e}=t.rectangle;return l(e)?St(e.left,e.right,this._elevationMode):null}get _ySize(){const t=this._createOperationGeometry;if(g(t)||g(t.rectangle))return null;const{midpoints:e}=t.rectangle;return l(e)?St(e.top,e.bottom,this._elevationMode):null}get _fullGeometryArea(){const t=this._createOperationGeometry,e=l(t)?t.full:null;return g(e)||e.type!=="polygon"?null:Qt(e,this._elevationMode)}get _elevationTooltipDetail(){return{mode:this.drawOperation.elevationInfo.mode,...this._vertexTooltipElevation}}get _vertexTooltipElevation(){var r,p;const{tooltipOptions:t,view:e,drawOperation:i}=this;if(g(i))return this._defaultElevation;const n=(r=i.stagedVertex)!=null?r:i.lastVertex;if(g(n)||e.type==="2d")return this._defaultElevation;const a={mode:t.elevation.mode,offset:0},o=((p=Zt(e,n,i.elevationInfo,a))!=null?p:0)*Qe(n.spatialReference);return Xt(o,"meters")}get _elevationMode(){return this.drawOperation.isDraped?"on-the-ground":"absolute-height"}};s([h()],m.prototype,"_createOperationGeometry",void 0),s([h()],m.prototype,"_defaultElevation",null),s([h({value:!0})],m.prototype,"centered",null),s([h({nonNullable:!0})],m.prototype,"defaultZ",void 0),s([h()],m.prototype,"drawOperation",void 0),s([h({value:!0})],m.prototype,"enabled",null),s([h({value:!0})],m.prototype,"forceUniformSize",null),s([h({constructOnly:!0})],m.prototype,"geometryType",void 0),s([h()],m.prototype,"graphic",null),s([h({constructOnly:!0})],m.prototype,"graphicProperties",void 0),s([h()],m.prototype,"graphicSymbol",null),s([h({constructOnly:!0})],m.prototype,"hasZ",void 0),s([h({constructOnly:!0,type:yt})],m.prototype,"labelOptions",void 0),s([h({constructOnly:!0})],m.prototype,"mode",void 0),s([h()],m.prototype,"snappingManager",void 0),s([h()],m.prototype,"snapToScene",void 0),s([h()],m.prototype,"tooltip",void 0),s([h({constructOnly:!0,type:vt})],m.prototype,"tooltipOptions",void 0),s([h({readOnly:!0})],m.prototype,"type",void 0),s([h({readOnly:!0})],m.prototype,"updating",null),s([h({constructOnly:!0,nonNullable:!0})],m.prototype,"view",void 0),s([h()],m.prototype,"_tooltipInfo",null),s([h()],m.prototype,"_drawPointTooltipInfo",null),s([h()],m.prototype,"_drawPolylineTooltipInfo",null),s([h()],m.prototype,"_drawPolygonTooltipInfo",null),s([h()],m.prototype,"_drawRectangleTooltipInfo",null),s([h()],m.prototype,"_drawCircleTooltipInfo",null),s([h()],m.prototype,"_circleRadius",null),s([h()],m.prototype,"_xSize",null),s([h()],m.prototype,"_ySize",null),s([h()],m.prototype,"_fullGeometryArea",null),s([h()],m.prototype,"_elevationTooltipDetail",null),s([h()],m.prototype,"_vertexTooltipElevation",null),s([h()],m.prototype,"_elevationMode",null),m=s([z("esri.views.draw.DrawGraphicTool")],m);const Ot="create-operation-graphic",C={outline:"outline-visual",regularVertices:"regular-vertices-visual",activeVertex:"active-vertex-visual"};function an(t){switch(t){case"point":case"polyline":case"polygon":case"multipoint":return t;case"circle":case"rectangle":return"segment"}}const oe=48,Se="click";class $i{constructor({grabbableForEvent:e}){this.events=new At,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=e}intersectionDistance(e,i){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}}function Ii(t,e){let i=null,n=null;return a=>{if(a.action==="cancel")return void(l(n)&&(n.execute({action:"cancel"}),i=null,n=null));const o={action:a.action,screenStart:a.start,screenEnd:a.screenPoint};a.action==="start"&&g(i)&&(i=new rt,n=new rt,e(t,i,n,a.pointerType,o)),l(i)&&i.execute(o),a.action==="end"&&l(i)&&(i=null,n=null)}}function Et(t,e){return t.events.on("drag",Ii(t,e))}function rn(t,e){var p;const i=[t.x,t.y,(p=t.z)!=null?p:0],n=e,a=[Math.cos(n),Math.sin(n)],o=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(o===0)return null;a[0]/=o,a[1]/=o;const r=c=>{const u=(c.x-i[0])*a[0]+(c.y-i[1])*a[1];c.x=i[0]+u*a[0],c.y=i[1]+u*a[1]};return c=>(r(c.mapStart),r(c.mapEnd),{...c,axis:a})}function Pi(t,e){let i=null;return n=>{if(n.action==="start"&&(i=Vi(t,n.mapStart.spatialReference,e)),g(i))return null;const a=n.mapEnd.x-n.mapStart.x,o=n.mapEnd.y-n.mapStart.y,r=n.mapEnd.z-n.mapStart.z;return i.move(a,o,r),{...n,translationX:a,translationY:o,translationZ:r}}}function Me(t,e){return g(t)?null:t.spatialReference.equals(e)?t.clone():ft(t,e)}function Vi(t,e,i){const n=t.geometry,a=xi(e);if(g(n))return null;if(n.type==="mesh")return Ci(t,n,a,i);const o=Me(n,a),r=n.spatialReference;return g(o)?null:{move:(p,c,u)=>{const d=xe(o.clone(),p,c,u);d.spatialReference.equals(r)?t.geometry=d:t.geometry=ft(d,r)}}}function Ci(t,e,i,n){if(l(e.transform))return Ri(t,e,e.transform,i);if(!e.spatialReference.equals(i))return null;let a=0,o=0,r=0;return{move:(p,c,u)=>{const d=p-a,y=c-o,f=u-r;if(d||y||f){const b=new K(e.origin.x+d,e.origin.y+y,e.origin.z+f,e.origin.spatialReference);e.centerAt(b,{geographic:n===de.Global}),t.notifyGeometryChanged(),a=p,o=c,r=u}}}}function Ri(t,e,i,n){const a=Me(i.getOriginPoint(e.spatialReference),n),o=e.spatialReference;return g(a)?null:{move:(r,p,c)=>{const u=xe(a.clone(),r,p,c);if(u.spatialReference.equals(o))i.origin=Pt(u.x,u.y,u.z);else{const d=ft(u,o);l(d)&&(i.origin=Pt(d.x,d.y,d.z))}t.notifyMeshTransformChanged(),t.notifyGeometryChanged()}}}function sn(t,e=null,i){var r;let n=null;const a=l(e)&&!((r=t.spatialReference)!=null&&r.equals(e))?p=>l(p)?ft(p,e):p:p=>p,o={exclude:[],...i};return p=>{if(p.action==="start"&&(n=a(t.toMap(p.screenStart,o))),g(n))return null;const c=a(t.toMap(p.screenEnd,o));return l(c)?{...p,mapStart:n,mapEnd:c}:null}}function ln(t,e){const i=t.map(n=>st(Pi(n,e))).filter(n=>l(n));return n=>{const a=n.mapEnd.x-n.mapStart.x,o=n.mapEnd.y-n.mapStart.y,r=n.mapEnd.z-n.mapStart.z;return i.forEach(p=>p(n)),{...n,translationX:a,translationY:o,translationZ:r}}}function zi(t,e){const i=new Map;for(const n of e)i.set(n,Dt(t[n]));return n=>(i.forEach((a,o)=>{t[o]=a}),n)}function Gi(t){return l(t.geometry)&&t.geometry.type==="mesh"?Di(t,t.geometry):zi(t,["geometry"])}function Di(t,e){const i=l(e.transform)?e.transform.clone():null,n=e.vertexAttributes.clonePositional();return a=>(e.transform=i,e.vertexAttributes=n,t.notifyGeometryChanged(),a)}function pn(t){const e=t.map(i=>st(Gi(i))).filter(i=>l(i));return i=>(e.forEach(n=>n(i)),i)}function cn(){let t=0,e=0,i=0;return n=>{n.action==="start"&&(t=n.mapStart.x,e=n.mapStart.y,i=n.mapStart.z);const a=n.mapEnd.x-t,o=n.mapEnd.y-e,r=n.mapEnd.z-i;return t=n.mapEnd.x,e=n.mapEnd.y,i=n.mapEnd.z,{...n,mapDeltaX:a,mapDeltaY:o,mapDeltaZ:r,mapDeltaSpatialReference:n.mapStart.spatialReference}}}function hn(){let t=0,e=0;return i=>{i.action==="start"&&(t=i.screenStart.x,e=i.screenStart.y);const n=i.screenEnd.x-t,a=i.screenEnd.y-e;return t=i.screenEnd.x,e=i.screenEnd.y,{...i,screenDeltaX:n,screenDeltaY:a}}}function un(t,e){let i=null,n=0,a=0;return o=>{var u;if(o.action==="start"&&(i=(u=t.toScreen)==null?void 0:u.call(t,e),i!=null&&(i.x<0||i.x>t.width||i.y<0||i.y>t.height?i=null:(n=o.screenStart.x-i.x,a=o.screenStart.y-i.y))),i==null)return null;const r=jt(o.screenEnd.x-n,0,t.width),p=jt(o.screenEnd.y-a,0,t.height),c=ge(r,p);return o.screenStart=i,o.screenEnd=c,o}}const Ai=()=>{};class rt{constructor(){this.execute=Ai}next(e,i=new rt){return l(e)&&(this.execute=n=>{const a=e(n);l(a)&&i.execute(a)}),i}}function Zi(t,e,i=[]){if(t.type==="2d")return a=>a;let n=null;return a=>{a.action==="start"&&(n=t.toMap(a.screenStart,{exclude:i}),l(n)&&(n.z=dt(n,t,e)));const o=t.toMap(a.screenEnd,{exclude:i});l(o)&&(o.z=dt(o,t,e));const r=l(n)&&l(o)?{sceneStart:n,sceneEnd:o}:null;return{...a,scenePoints:r}}}function ae(t,e,i){var o,r;const n=(r=ti(e.elevationProvider.getElevation(t.x,t.y,(o=t.z)!=null?o:0,t.spatialReference,"scene")))!=null?r:0,a=_t(t);return a.z=n,a.hasZ=!0,a.z=dt(a,e,i),a}function dn(t,e){if(t.type==="2d")return n=>n;let i=null;return n=>{n.action==="start"&&(i=ae(n.mapStart,t,e));const a=ae(n.mapEnd,t,e),o=l(i)&&l(a)?{sceneStart:i,sceneEnd:a}:null;return{...n,scenePoints:o}}}function Fi({predicate:t=()=>!0,snappingManager:e,snappingContext:i,updatingHandles:n,useZ:a=!0}){const o=new rt;if(g(e))return{snappingStep:[re,o],cancelSnapping:re};let r,p=null,c=null,u=null;const d=()=>{p=Vt(p),e.doneSnapping(),l(c)&&c.frameTask.remove(),c=null,r=ve(r),u=null},y=ki(e,a,o);let f=null,b=null,x=null;return{snappingStep:[w=>{if(!t(w))return w;const{action:I}=w;if(I==="start"){const{info:O}=w,S=Hi(e.view);if(c=ji(i,w,S),c.context.selfSnappingZ=null,!a&&l(O)){const G=Wi(i.coordinateHelper,O.handle.component);l(G)&&(c.context.selfSnappingZ={value:G,elevationInfo:i.elevationInfo})}}if(l(c)){const{context:O,originalScenePos:S,originalPos:G}=c,{mapEnd:tt,mapStart:et,scenePoints:P}=w,it=Oe(G,Gt(tt,et)),pt=Gt(et,G),Ie={...w,action:"update"},Pe=c.context,xt=Ui(S,P),Ft=e.update({point:it,scenePoint:xt,context:O});if(x=Ft,Ee(tt,Ft,pt,a),f=it,b=xt,I!=="end"){const{frameTask:Ve}=c;g(p)&&(p=new AbortController),u=Ce=>{n.addPromise(Ct(y({frameTask:Ve,event:Ie,context:Pe,point:it,scenePoint:xt,delta:pt,getLastState:()=>({point:f,scenePoint:b,updatePoint:Ce.forceUpdate?null:x})},st(p).signal)))},u({forceUpdate:!1}),g(r)&&(r=at(()=>e.options.effectiveEnabled,()=>u==null?void 0:u({forceUpdate:!0})))}}return I==="end"&&d(),w},o],cancelSnapping:w=>(d(),w)}}function ki(t,e,i){return fe(async({frameTask:n,point:a,scenePoint:o,context:r,event:p,delta:c,getLastState:u},d)=>{const y=await n.schedule(()=>t.snap({point:a,scenePoint:o,context:r,signal:d}),d);if(y.valid){let f=await n.schedule(()=>y.apply(),d);const b=u();l(b.point)&&a!==b.point&&(f=t.update({point:b.point,scenePoint:b.scenePoint,context:r})),!g(b.updatePoint)&&zt(f,b.updatePoint)||(Ee(p.mapEnd,f,c,e),i.execute(p))}})}function Hi(t){return t.type==="3d"?t.resourceController.scheduler.registerTask(me.SNAPPING):ye}function ji(t,e,i){return{context:new Rt({editGeometryOperations:t.editGeometryOperations,elevationInfo:t.elevationInfo,pointer:t.pointer,vertexHandle:l(e.info)?e.info.handle:null,excludeFeature:t.excludeFeature,visualizer:t.visualizer}),originalPos:l(e.snapOrigin)?t.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:l(e.scenePoints)?e.scenePoints.sceneStart:null,frameTask:i}}function Oe(t,[e,i,n]){const a=_t(t);return a.x+=e,a.y+=i,a.hasZ&&(a.z+=n),a}function Ui(t,e){return g(t)||g(e)?null:Oe(t,Gt(e.sceneEnd,e.sceneStart))}function Gt(t,e){const i=t.hasZ&&e.hasZ?t.z-e.z:0;return[t.x-e.x,t.y-e.y,i]}function Ee(t,e,[i,n,a],o){t.x=e.x+i,t.y=e.y+n,o&&t.hasZ&&e.hasZ&&(t.z=e.z+a)}function Wi(t,e){if(!t.hasZ())return null;const i=e.vertices;let n=null;for(const a of i){const o=t.getZ(a.pos);if(l(n)&&l(o)&&Math.abs(o-n)>1e-6)return null;g(n)&&(n=o)}return n}function re(t){return t}let W=class extends he{constructor(t){super(t),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=fe(async(e,i,n,a)=>{const o=this._frameTask;if(g(o))return;const r=await o.schedule(()=>i.snap({...e,context:n,signal:a}),a);r.valid&&await o.schedule(()=>{this.stagedPoint=r.apply(),e!==this._snapPoints&&l(this._snapPoints)&&(this.stagedPoint=i.update({...this._snapPoints,context:n}))},a)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(t){this._stagedPoint=this.constrainResult(t)}initialize(){var e,i;const t=this.view.type==="3d"?(i=(e=this.view)==null?void 0:e.resourceController)==null?void 0:i.scheduler:null;this._frameTask=l(t)?t.registerTask(me.SNAPPING):ye}destroy(){this._abortController=Vt(this._abortController),this._frameTask=ve(this._frameTask)}update(t,e,i){this._snapPoints=t;const{point:n,scenePoint:a}=t,o=e.update({point:n,scenePoint:a,context:i});return this.stagedPoint=o,o}async snap(t,e,i){const{point:n,scenePoint:a}=t;return this.stagedPoint=e.update({point:n,scenePoint:a,context:i}),this._snapPoints=t,g(this._abortController)&&(this._abortController=new AbortController),this._snap(t,e,i,this._abortController.signal)}async resnap(t,e){g(this._snapPoints)||await this.snap(this._snapPoints,t,e)}abort(){this._abortController=Vt(this._abortController),this._snapPoints=null}};s([h({constructOnly:!0})],W.prototype,"view",void 0),s([h()],W.prototype,"stagedPoint",null),s([h()],W.prototype,"constrainResult",void 0),s([h()],W.prototype,"_stagedPoint",void 0),W=s([z("esri.views.interactive.snapping.SnappingOperation")],W);let _=class extends At.EventedMixin(ei){constructor(t){super(t),this._createOperationCompleted=!1,this._pointerDownStates=new Set,this.isDraped=!0,this.labelOptions=new yt,this.tooltipOptions=new vt,this.snapToSceneEnabled=null,this.lastVertex=null,g(t.elevationInfo)&&(this.elevationInfo=ii(!!t.hasZ))}initialize(){const{geometryType:t,view:e}=this,i=e.spatialReference,n="viewingMode"in e.state?e.state.viewingMode:de.Local,a=t==="segment"||t==="multipoint"?"polyline":t;this.coordinateHelper=ui(this.hasZ,this.hasM,i),this._editGeometryOperations=new di(new gi(a,this.coordinateHelper)),this._snappingOperation=new W({view:e,constrainResult:r=>{var p;return g(r)?r:(p=this._getEffectiveDrawSurface())==null?void 0:p.constrainZ(r)}}),this.handles.add(at(()=>this.stagedVertex,r=>{g(r)||this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(r)}],operation:"apply",type:"vertex-update"})},{sync:!0,equals:(r,p)=>oi(r,p,zt)})),this._activeComponent=new mi(i,n),this._editGeometryOperations.data.components.push(this._activeComponent);const o=this.segmentLabels;l(o)&&(o.context={view:e,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions},this.handles.add([at(()=>this.labelOptions.enabled,r=>{o.visible=r},It),this.on("cursor-update",()=>{const r=this.stagedVertex;o.stagedVertex=l(r)?this.coordinateHelper.pointToVector(r):null})])),this.handles.add(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],r=>{const p=r.vertices.map(y=>({componentIndex:0,vertexIndex:y.index,coordinates:this.coordinateHelper.vectorToArray(y.pos)})),c=p.map(y=>y.coordinates);switch(r.type){case"vertex-add":this.emit(r.type,{...r,added:c,vertices:p});break;case"vertex-update":this.emit(r.type,{...r,updated:c,vertices:p});break;case"vertex-remove":this.emit(r.type,{...r,removed:c,vertices:p})}const u=this._activeComponent.getLastVertex(),d=l(u)?this.coordinateHelper.vectorToDehydratedPoint(u.pos):null;(g(d)||g(this.lastVertex)||!zt(this.lastVertex,d))&&(this.lastVertex=d)})),this._manipulator=new $i({grabbableForEvent:r=>this.drawingMode!=="click"||r.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1}),this.manipulators.add(this._manipulator),this._manipulator.grabbable=t!=="point",this.handles.add([this._createManipulatorDragPipeline(this._manipulator),this._manipulator.events.on("immediate-click",r=>this._onImmediateClick(r)),this._manipulator.events.on("immediate-double-click",r=>this._onImmediateDoubleClick(r))]),ni(this,()=>{const r=V(this.view.inputManager.latestPointerType,"mouse"),p=this._getSnappingContext(r);l(this.snappingManager)&&this.updatingHandles.addPromise(Ct(this._snappingOperation.resnap(this.snappingManager,p)))})}destroy(){F(this.segmentLabels),F(this._snappingOperation),this._editGeometryOperations=F(this._editGeometryOperations)}get _snappingEnabled(){return l(this.snappingManager)&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const t=this._getEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==t}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map(t=>this.coordinateHelper.vectorToArray(t.pos))}set drawingMode(t){this._set("drawingMode",t!=null?t:Se)}get interactive(){return this._manipulator.interactive}set interactive(t){this._manipulator.interactive=t}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get numVertices(){return l(this.stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get snappingOptions(){return l(this.snappingManager)?this.snappingManager.options:null}get stagedVertex(){return this._snappingOperation.stagedPoint}set stagedVertex(t){this._snappingOperation.stagedPoint=Dt(t)}get updating(){return this.updatingHandles.updating}get vertices(){const t=this.committedVertices;return l(this.stagedVertex)&&t.push(this.coordinateHelper.pointToArray(this.stagedVertex)),t}cancel(){this.complete({aborted:!0})}commitStagedVertex(){if(this._snappingOperation.abort(),l(this.stagedVertex)){const{stagedVertex:t}=this;this.stagedVertex=null,this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(t))}}complete(t){const e=t&&t.aborted||!1;this._snappingOperation.abort(),l(this.snappingManager)&&this.snappingManager.doneSnapping(),this.geometryType==="segment"||this.geometryType==="point"?this.commitStagedVertex():this.stagedVertex=null;const i=this.geometryType==="multipoint"&&this.numVertices===0||this.geometryType==="polyline"&&this.numVertices<2||this.geometryType==="polygon"&&this.numVertices<3;this._createOperationCompleted=!i,(this.isCompleted||e)&&this.emit("complete",{vertices:this.vertices.map((n,a)=>({componentIndex:0,vertexIndex:a,coordinates:n})),aborted:e,type:"complete"})}onInputEvent(t){switch(t.type){case"pointer-down":this._pointerDownStates.add(t.pointerId);break;case"pointer-up":this._pointerDownStates.delete(t.pointerId)}switch(t.type){case"pointer-move":return this._onPointerMove(t);case"hold":return this._onHold(t)}}redo(){this._editGeometryOperations.redo()}undo(){l(this.snappingManager)&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_closeOnClickVertexIndex(t){const e=this._activeComponent;if(this.geometryType==="polygon"&&e.vertices.length>2){if(this._vertexWithinPointerDistance(e.vertices[0].pos,t))return 0;if(this._vertexWithinPointerDistance(e.vertices[e.vertices.length-1].pos,t))return e.vertices.length-1}return null}_createManipulatorDragPipeline(t){switch(st(this.drawingMode)){case"click":return this._createManipulatorDragPipelineClick(t);case"freehand":return this._createManipulatorDragPipelineFreehand(t);case"hybrid":return this._createManipulatorDragPipelineHybrid(t)}}_createManipulatorDragPipelineClick(t){return Et(t,(e,i,n,a)=>{const o=a==="touch"&&this._snappingEnabled;if(this.isCompleted||!o)return;const{snappingStep:r,cancelSnapping:p}=Fi({predicate:()=>o,snappingManager:this.snappingManager,snappingContext:new Rt({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:a,visualizer:this.snappingVisualizer}),updatingHandles:this.updatingHandles,useZ:!this._requiresScenePoint});n=n.next(c=>(o&&l(this.snappingManager)&&this.snappingManager.doneSnapping(),c)).next(p),i.next(this._screenToMapDragEventStep()).next(c=>(c.action==="start"&&(this.stagedVertex=c.mapStart,(this.geometryType==="segment"||o&&this.numVertices===0)&&this.commitStagedVertex()),c)).next(Zi(this.view,this.elevationInfo)).next(...r).next(c=>(o&&(this.stagedVertex=c.mapEnd,c.action==="end"&&this.commitStagedVertex()),c)).next(c=>(c.action==="end"&&(this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),c))})}_createManipulatorDragPipelineFreehand(t){return Et(t,(e,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(g(this.stagedVertex)&&(this.stagedVertex=n.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this.stagedVertex=n.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return n})})}_createManipulatorDragPipelineHybrid(t){return Et(t,(e,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(g(this.stagedVertex)&&(this.stagedVertex=n.mapStart),this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this.stagedVertex=n.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return n})})}get _drawAtFixedElevation(){return(this.geometryType==="segment"||this.geometryType==="polygon")&&this.numCommittedVertices>0}_getEffectiveDrawSurface(){if(g(this.elevationDrawSurface))return this.drawSurface;if(!this.coordinateHelper.hasZ())return this.elevationDrawSurface.defaultZ=null,this.elevationDrawSurface;let t=this.defaultZ,e=!1;return l(this.elevationInfo)&&this.elevationInfo.mode==="absolute-height"&&(e=!0),l(this.snapToSceneEnabled)&&(e=this.snapToSceneEnabled),l(this.elevationInfo)&&this.elevationInfo.mode==="on-the-ground"&&(e=!1),this._drawAtFixedElevation&&(t=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),e=!1),e?this.drawSurface:(this.elevationDrawSurface.defaultZ=t,this.elevationDrawSurface)}_mapToScreen(t){var e;return(e=this._getEffectiveDrawSurface())==null?void 0:e.mapToScreen(t)}_onHold(t){this._snappingOperation.abort(),this.drawingMode==="click"&&t.pointerType==="touch"&&this._snappingEnabled&&(this.stagedVertex=t.mapPoint),t.stopPropagation()}_onImmediateClick(t){if(t.pointerType==="mouse"&&t.button===2||this._manipulator.dragging)return;const e=this._activeComponent,i=this._closeOnClickVertexIndex(t.screenPoint);if(l(i))return t.stopPropagation(),void this.complete();const n=this._screenToMap(t.screenPoint);if(l(n))switch(this.drawingMode){case"freehand":this.geometryType==="point"&&(l(this.stagedVertex)?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),this.complete());break;case"click":case"hybrid":this._snappingOperation.abort(),l(this.stagedVertex)?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),(this.geometryType==="point"||this.geometryType==="segment"&&e.vertices.length===2||this.geometryType==="segment"&&this.drawingMode==="hybrid"&&e.vertices.length===1)&&this.complete()}t.stopPropagation()}_onImmediateDoubleClick(t){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),t.stopPropagation())}_onPointerMove(t){var c;const e=ge(t.x,t.y),i=this._snappingOperation;if(this._manipulator.dragging||this._pointerDownStates.has(t.pointerId)||this._manipulator.grabbing||!this._manipulator.interactive)return void i.abort();t.stopPropagation();const n=this._closeOnClickVertexIndex(e);if(l(n))return this._closeOnVertex(n),void i.abort();const a=this._screenToMap(e),o=this._requiresScenePoint?(c=this.drawSurface)==null?void 0:c.screenToMap(e):null;if(this._manipulator.cursor=l(a)?"crosshair":null,g(a))return void i.abort();const r=this.snappingManager;if(g(r))return this.stagedVertex=a,void i.abort();const p=this._getSnappingContext(t.pointerType);this.updatingHandles.addPromise(Ct(i.snap({point:a,scenePoint:o},r,p)))}_closeOnVertex(t){this.stagedVertex=null;const e={componentIndex:0,vertexIndex:t,coordinates:this.coordinateHelper.vectorToArray(this._activeComponent.vertices[t].pos)};this.emit("cursor-update",{updated:null,vertices:[e],operation:"apply",type:"vertex-update"})}_screenToMap(t){var e;return(e=this._getEffectiveDrawSurface())==null?void 0:e.screenToMap(t)}_screenToMapDragEventStep(){let t=null;return e=>{if(e.action==="start"&&(t=this._screenToMap(e.screenStart)),g(t))return null;const i=this._screenToMap(e.screenEnd);return l(i)?{...e,mapStart:t,mapEnd:i}:null}}_vertexWithinPointerDistance(t,e){const n=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(t));return!!l(n)&&Li(n,e,25)}_getSnappingContext(t){const e=this._drawAtFixedElevation?ue(this.elevationDrawSurface,({defaultZ:i})=>i):null;return new Rt({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:t,visualizer:this.snappingVisualizer,selfSnappingZ:l(e)?{value:e,elevationInfo:this.elevationInfo}:null})}};function Li(t,e,i){const n=t.x-e.x,a=t.y-e.y;return n*n+a*a<=i}s([h()],_.prototype,"_snappingEnabled",null),s([h()],_.prototype,"defaultZ",void 0),s([h()],_.prototype,"isDraped",void 0),s([h({value:Se})],_.prototype,"drawingMode",null),s([h({constructOnly:!0})],_.prototype,"elevationDrawSurface",void 0),s([h({constructOnly:!0})],_.prototype,"elevationInfo",void 0),s([h({constructOnly:!0,type:yt})],_.prototype,"labelOptions",void 0),s([h({constructOnly:!0,type:vt})],_.prototype,"tooltipOptions",void 0),s([h({constructOnly:!0})],_.prototype,"geometryType",void 0),s([h({constructOnly:!0})],_.prototype,"hasM",void 0),s([h({constructOnly:!0})],_.prototype,"hasZ",void 0),s([h({constructOnly:!0})],_.prototype,"manipulators",void 0),s([h({constructOnly:!0})],_.prototype,"drawSurface",void 0),s([h({constructOnly:!0})],_.prototype,"segmentLabels",void 0),s([h({constructOnly:!0})],_.prototype,"snappingManager",void 0),s([h({constructOnly:!0})],_.prototype,"snappingVisualizer",void 0),s([h()],_.prototype,"snapToSceneEnabled",void 0),s([h()],_.prototype,"_snappingOperation",void 0),s([h()],_.prototype,"stagedVertex",null),s([h()],_.prototype,"lastVertex",void 0),s([h()],_.prototype,"updating",null),s([h({constructOnly:!0})],_.prototype,"view",void 0),_=s([z("esri.views.draw.DrawOperation")],_);class gn{constructor(e,i,n,a=null){this._elevationInfo=e,this.defaultZ=i,this._view=n,this._excludeGraphics=a}screenToMap(e){if(l(this.defaultZ))return this._view.sceneIntersectionHelper.intersectElevationFromScreen(Ut(e.x,e.y),this._elevationInfo,this.defaultZ,this._excludeGraphics);const i=this._view.sceneIntersectionHelper.intersectElevationFromScreen(Ut(e.x,e.y),this._elevationInfo,0,this._excludeGraphics);return l(i)&&(i.z=void 0),i}mapToScreen(e){const i=_e(e.x,e.y,Zt(this._view,e,this._elevationInfo),e.spatialReference);return this._view.toScreen(i)}constrainZ(e){const{defaultZ:i}=this;return l(i)&&e.z!==i&&((e=_t(e)).z=i),e}}class mn{constructor(e,i,n=[]){this.view=e,this.elevationInfo=i,this.exclude=n}screenToMap(e){const i=this.view.toMap(e,{exclude:this.exclude});return l(i)&&(i.z=dt(i,this.view,this.elevationInfo)),i}mapToScreen(e){let i=e;return l(this.elevationInfo)&&(i=_e(e.x,e.y,Zt(this.view,e,this.elevationInfo),e.spatialReference)),this.view.toScreen(i)}constrainZ(e){return e}}class yn{constructor(e,i=!1,n=0){this.view=e,this.hasZ=i,this.defaultZ=n,this.mapToScreen=a=>e.toScreen(a),this.screenToMap=i?a=>{const o=e.toMap(a);return o.z=n,o}:a=>e.toMap(a)}constrainZ(e){const{defaultZ:i}=this;return this.hasZ&&e.z!==i&&((e=_t(e)).z=i),e}}function vn(t,e){return $e(t,e,!1)}function fn(t,e){return $e(t,e,!0)}function $e(t,e,i){if(t instanceof yi){if(t.operation instanceof vi)return Ni(t.operation,e,i),!0;if(t.operation instanceof fi)return qi(t.operation,e,i),!0;if(t.operation instanceof _i)return Yi(t.operation,e,i),!0}return!1}function Ni(t,e,i=!1){const n=i?-1:1,a=Pt(n*t.dx,n*t.dy,n*t.dz);ot(e.origin,e.origin,a)}function qi(t,e,i=!1){const n=i?-t.angle:t.angle;Wt(e.basis1,e.basis1,Lt,n),Wt(e.basis2,e.basis2,Lt,n)}function Yi(t,e,i=!1){const n=i?1/t.factor1:t.factor1,a=i?1/t.factor2:t.factor2;X(e.basis1,e.basis1,n),X(e.basis2,e.basis2,a),Nt(e.origin,e.origin,t.origin,t.axis1,n),Nt(e.origin,e.origin,t.origin,t.axis2,a)}function _n(t,e,i,n){n||(n=we());const a=q(nt.get(),t[1],-t[0]),o=q(nt.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=q(nt.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),p=nt.get();e.components.forEach(d=>d.vertices.forEach(y=>{const f=y.pos;q(p,qt(t,f),qt(a,f)),ai(o,o,p),ri(r,r,p)}));const c=1e-6,u=q(nt.get(),r[0]-o[0]<c?i/2:0,r[1]-o[1]<c?i/2:0);return si(o,o,u),bt(r,r,u),Yt(n.basis1,t,(r[0]-o[0])/2),Yt(n.basis2,a,(r[1]-o[1])/2),q(n.origin,o[0]*t[0]+o[1]*a[0],o[0]*t[1]+o[1]*a[1]),bt(n.origin,n.origin,n.basis1),bt(n.origin,n.origin,n.basis2),n}function xn(t,e,i,n=0,a){a||(a=we()),e.toRenderCoords(t.origin,i,a.origin);const o=M.get();ot(o,t.origin,t.basis1),ot(o,o,t.basis2),e.toRenderCoords(o,i,o);const r=M.get();ot(r,t.origin,t.basis1),$(r,r,t.basis2),e.toRenderCoords(r,i,r);const p=M.get();$(p,t.origin,t.basis1),$(p,p,t.basis2),e.toRenderCoords(p,i,p);const c=M.get();$(c,t.origin,t.basis1),ot(c,c,t.basis2),e.toRenderCoords(c,i,c);const u=H(M.get(),o,r,.5);$(u,u,a.origin);const d=H(M.get(),p,c,.5);$(d,a.origin,d),H(a.basis1,u,d,.5);const y=H(M.get(),c,o,.5);$(y,y,a.origin);const f=H(M.get(),r,p,.5);$(f,a.origin,f),H(a.basis2,y,f,.5);const b=$t(M.get(),a.basis1,a.basis2),x=$t(b,b,a.basis1);return le(x,x),X(a.basis2,x,se(a.basis2,x)),X(a.basis1,a.basis1,1+n/Bt(a.basis1)),X(a.basis2,a.basis2,1+n/Bt(a.basis2)),wi(a),a}function wn(t,e,i,n){const a=M.get();$(a,$(a,t.origin,t.basis1),t.basis2);const o=M.get();Tt(o,a,t.basis1,2);const r=M.get();Tt(r,o,t.basis2,2);const p=M.get();Tt(p,a,t.basis2,2),a[2]=o[2]=r[2]=p[2]=e;const c=n?"on-the-ground":"absolute-height",u=Jt(ct(a,o,i,c),ct(p,r,i,c)),d=Jt(ct(o,r,i,c),ct(a,p,i,c));return g(d)||g(u)?null:[u,d]}export{_n as A,an as B,un as C,cn as D,Pi as E,xn as G,m as H,Gi as M,ln as R,vn as S,rt as U,Zi as X,fn as Y,dn as Z,yn as a,hn as b,mn as c,wn as d,rn as g,_ as k,Fi as m,gn as o,T as p,pn as q,sn as v,Et as x};
